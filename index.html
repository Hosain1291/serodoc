<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ë¡œì“°ê¸° ë¬¸ì„œ ìƒì„±ê¸° (ë„ì¥/ì»¤ìŠ¤í…€í°íŠ¸)</title>
    <!-- html2canvas ëŒ€ì‹  html-to-image ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (ì„¸ë¡œì“°ê¸° ì§€ì›) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <style>
        /* ê¸°ë³¸ ì›¹í°íŠ¸ ì •ì˜ */
        @font-face { font-family: 'Sangjang'; src: url('ìƒì¥ì²´B-Bold.woff') format('woff'); }
        @font-face { font-family: 'Dobong'; src: url('dobonghan-Medium.woff') format('woff'); }
        @font-face { font-family: 'Jinin'; src: url('Jinin-B.woff') format('woff'); }
        @font-face { font-family: 'Gaehangro'; src: url('Gaehangro-H.woff') format('woff'); }
        @font-face { font-family: 'Song'; src: url('Song-B.woff') format('woff'); }
        @font-face { font-family: 'Jalnan'; src: url('Jalnan-Regular.woff') format('woff'); }
        @font-face { font-family: 'Solmoe'; src: url('SolmoeKimDaeGeonhan-Medium.woff') format('woff'); }

        /* UI ìŠ¤íƒ€ì¼ */
        body {
            background-color: #2b2b2b;
            color: #eee;
            font-family: 'Malgun Gothic', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 { margin-bottom: 20px; text-shadow: 2px 2px 4px #000; }

        .container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls {
            background: #444;
            padding: 20px;
            border-radius: 8px;
            color: #fff;
            width: 340px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: bold;
            border-bottom: 1px solid #777;
            padding-bottom: 5px;
            margin-bottom: 10px;
            margin-top: 10px;
            color: #ffcc00;
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        label { font-size: 0.9em; color: #ccc; }
        
        /* ì…ë ¥ì°½(textarea) ìŠ¤íƒ€ì¼ */
        textarea {
            width: 100%; 
            height: 150px; 
            padding: 10px;
            background: #333; 
            color: #fff; 
            border: 1px solid #555;
            border-radius: 4px; 
            resize: vertical; 
            font-size: 16px;
            line-height: 1.6;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
        }

        input[type="text"], select, input[type="file"], input[type="range"], input[type="color"] {
            width: 100%; padding: 8px;
            background: #333; color: #fff; border: 1px solid #555;
            border-radius: 4px; box-sizing: border-box;
        }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #555;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #fff;
        }

        button {
            background: #5a5a5a; color: white; border: none;
            padding: 10px; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: background 0.2s; margin-top: 5px;
        }
        button:hover { background: #777; }
        button.primary { background: #007bff; }
        button.primary:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.warning { background: #ffc107; color: #333; }
        button.success { background: #28a745; }

        /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .preview-wrapper {
            background: #555;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto; 
            max-width: calc(100vw - 400px);
            min-width: 500px;
            display: flex;
            direction: rtl; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        /* ì¢…ì´ ìŠ¤íƒ€ì¼ */
        #paper {
            position: relative; 
            writing-mode: vertical-rl;
            text-orientation: mixed;
            direction: ltr; /* ê¸€ì ë’¤ì§‘í˜ ë°©ì§€ */
            text-align: left;
            
            height: 700px; 
            width: fit-content; 
            min-width: 400px;
            
            background-color: #f4e4bc;
            color: #000;
            
            /* [ìˆ˜ì •] ê¸°ë³¸ ì—¬ë°± (ë¡œê³  ì—†ì„ ë•Œ) */
            padding: 70px 60px 60px 60px;
            box-sizing: border-box;
            
            font-family: 'Solmoe', 'Gungsuh', 'Batang', serif;
            font-size: 28px;
            line-height: 1.8;
            
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: break-word;
            
            transition: padding 0.3s ease, border 0.3s;
        }
        
        /* [ì¶”ê°€] ë¡œê³ ê°€ ìˆì„ ë•Œ ì ìš©ë˜ëŠ” í´ë˜ìŠ¤ */
        #paper.has-logo {
            padding-top: 170px; /* ë¡œê³  ë†’ì´(ì•½ 100px) + ì—¬ë°± í™•ë³´ */
        }
        
        /* ìƒì¥ í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ */
        #paper.certificate-mode {
            border: 10px double #daa520; /* ê¸ˆìƒ‰ ì´ì¤‘ í…Œë‘ë¦¬ */
            outline: 2px solid #daa520;
            outline-offset: -20px; /* ì•ˆìª½ ë¼ì¸ */
        }

        #paper p { margin: 0; white-space: pre-wrap; }

        /* ë¬¸ì¥ ë¶€í˜¸(ì ) ìœ„ì¹˜ ë³´ì • ìŠ¤íƒ€ì¼ */
        .punct {
            display: inline-block;
            position: relative;
            top: -0.45em; 
            margin-bottom: -0.45em; 
        }

        /* ìƒë‹¨ ì¤‘ì•™ ë¡œê³  ìŠ¤íƒ€ì¼ */
        #topLogo {
            position: absolute;
            top: 25px; /* í…Œë‘ë¦¬ ì•ˆìª½ ì ë‹¹í•œ ìœ„ì¹˜ */
            left: 50%;
            transform: translateX(-50%);
            max-width: 100px;
            max-height: 100px;
            opacity: 0.9;
            pointer-events: none; 
            z-index: 5;
        }

        /* ë„ì¥ ìŠ¤íƒ€ì¼ */
        .stamp {
            position: absolute;
            z-index: 10;
            cursor: move;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Hanja', 'Gungsuh', serif; 
            box-sizing: border-box;
            line-height: 1.2;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            mix-blend-mode: multiply; 
            direction: ltr;
        }

        /* [ìˆ˜ì •] ì´ë¯¸ì§€ ë„ì¥: ê·¸ë¦¼ì ì œê±° */
        .stamp.image {
            box-shadow: none;
        }

        .stamp.square {
            border-style: solid;
            border-width: 4px;
            writing-mode: vertical-rl; 
        }

        .stamp.circle {
            border-style: solid;
            border-width: 4px;
            border-radius: 50%;
            writing-mode: vertical-rl;
        }

        .stamp img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none; 
        }

        .stamp:active { opacity: 0.8; cursor: grabbing; }

        .stamp .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            border: 1px solid white;
            z-index: 100;
        }
        .stamp:hover .delete-btn { display: block; }

        @media (max-width: 800px) {
            .preview-wrapper { max-width: 100%; }
        }
    </style>
</head>
<body>

    <h1>ì„¸ë¡œì“°ê¸° ì„œì°° ìƒì„±ê¸° (ìƒì¥/ì™„ì „íŒ)</h1>

    <div class="container">
        <!-- ì„¤ì • íŒ¨ë„ -->
        <div class="controls">
            
            <div class="section-title">1. ê¸€ì“°ê¸° & í°íŠ¸</div>
            <div class="control-group">
                <textarea id="textInput" placeholder="ì´ê³³ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜¤ë¥¸ìª½ ì¢…ì´ì— ì„¸ë¡œë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.">
ìƒ ì¥

ì„±ëª…: í™ê¸¸ë™
ë¶€ë¬¸: ì„¸ë¡œì“°ê¸°

ìœ„ ì‚¬ëŒì€ ì„¸ë¡œì“°ê¸° ê¸°ëŠ¥ì„
í›Œë¥­í•˜ê²Œ í™œìš©í•˜ì˜€ê¸°ì—
ì´ ìƒì¥ì„ ìˆ˜ì—¬í•©ë‹ˆë‹¤.

2024ë…„ 5ì›” 20ì¼
ê°œë°œì ë“œë¦¼</textarea>
            </div>

            <div class="control-group">
                <label>ê¸€ì”¨ì²´ ì„ íƒ:</label>
                <select id="fontSelect">
                    <option value="'Sangjang', serif">ìƒì¥ì²´ (ìƒì¥ ì¶”ì²œ)</option>
                    <option value="'Solmoe', 'Gungsuh', serif">ì†”ë«¼ ê¹€ëŒ€ê±´</option>
                    <option value="'Jinin', 'Gungsuh', serif">ì§€ë‹Œì²´ (ë¶“ê¸€ì”¨)</option>
                    <option value="'Dobong', sans-serif">ë„ë´‰ì˜›ê¸¸</option>
                    <option value="'Gaehangro', sans-serif">ê°œí•­ë¡œ</option>
                    <option value="'Jalnan', sans-serif">ì˜ë‚œì²´</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>ğŸ“‚ ë‚´ í°íŠ¸ íŒŒì¼ ì¶”ê°€ (.ttf, .woff):</label>
                <input type="file" id="customFontFile" accept=".ttf, .otf, .woff, .woff2">
            </div>

            <div class="control-group">
                <label>ê¸€ì í¬ê¸° / ì¤„ ê°„ê²©:</label>
                <div style="display:flex; gap:5px;">
                    <input type="range" id="fontSize" min="16" max="60" value="28" style="flex:1">
                    <input type="range" id="lineHeight" min="10" max="30" value="18" style="flex:1">
                </div>
            </div>
            
            <div class="control-group">
                <label>ê¸€ì ìƒ‰ìƒ:</label>
                <input type="color" id="textColor" value="#000000">
            </div>

            <div class="section-title">2. ìƒì¥ ë° ë°°ê²½ ì„¤ì •</div>
            <div class="control-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="certificateMode">
                    <label for="certificateMode">ğŸ† ìƒì¥ í…Œë‘ë¦¬ ì ìš©</label>
                </div>
            </div>
            
            <div class="control-group">
                <label>ğŸ–¼ï¸ ìƒë‹¨ ì¤‘ì•™ ë¡œê³ /ë§ˆí¬:</label>
                <input type="file" id="logoImageFile" accept="image/*">
            </div>

            <div class="control-group">
                <label>ì¢…ì´ ìƒ‰ìƒ:</label>
                <input type="color" id="bgColor" value="#f4e4bc">
            </div>
            
            <div class="control-group">
                <label>ì¢…ì´ ë†’ì´ (ë¬¸ì„œ ê¸¸ì´):</label>
                <input type="range" id="paperHeight" min="400" max="1500" value="700">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="autoHeightCheck">
                <label for="autoHeightCheck">ì„¸ë¡œ ê¸¸ì´ ìë™ í™•ì¥</label>
            </div>

            <div class="section-title">3. ë„ì¥(ë‚™ê´€) ì°ê¸°</div>
            <div class="control-group">
                <label>ë„ì¥ ì¢…ë¥˜:</label>
                <select id="stampType">
                    <option value="square">ë„¤ëª¨ ë„ì¥ (ì´ë¦„)</option>
                    <option value="circle">ì›í˜• ë„ì¥ (ì´ë¦„)</option>
                    <option value="image">ì‚¬ì§„/ì´ë¯¸ì§€ ì—…ë¡œë“œ</option>
                </select>
            </div>
            
            <div id="textStampInput" class="control-group">
                <label>ì´ë¦„ (2~4ê¸€ì ì¶”ì²œ):</label>
                <input type="text" id="stampText" value="í™ê¸¸ë™ì¸" maxlength="6">
                <label>ë„ì¥ ìƒ‰ìƒ:</label>
                <input type="color" id="stampColor" value="#cc0000">
            </div>

            <div id="imageStampInput" class="control-group" style="display:none;">
                <label>ë„ì¥ ì´ë¯¸ì§€ íŒŒì¼:</label>
                <input type="file" id="stampImageFile" accept="image/*">
            </div>

            <button onclick="addStamp()" style="background:#8b4513;">ğŸ§§ ë„ì¥ ì°ê¸° (ìƒì„±)</button>
            
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button onclick="alignStamp('center')" class="success" style="flex:1;">â— ì¤‘ì•™ ì •ë ¬</button>
                <button onclick="alignStamp('bottom')" class="success" style="flex:1;">â†“ í•˜ë‹¨ ì •ë ¬</button>
            </div>

            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button id="undoStampBtn" class="warning" style="flex:1;">â†©ï¸ ë°©ê¸ˆ ì·¨ì†Œ</button>
                <button id="clearStampsBtn" class="danger" style="flex:1;">ğŸ—‘ï¸ ëª¨ë‘ ì‚­ì œ</button>
            </div>


            <div class="section-title">4. ì €ì¥</div>
            <button id="saveBtn" class="primary">ğŸ“¸ ì „ì²´ ì´ë¯¸ì§€(PNG) ì €ì¥</button>
        </div>

        <!-- ê²°ê³¼ë¬¼ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="preview-wrapper" id="previewWrapper">
            <div id="paper">
                <!-- ë¡œê³  ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ê³µê°„ -->
                <img id="topLogo" style="display:none;">
                
                <span id="contentArea">
                    ìƒ ì¥.<br><br>ì„±ëª…: í™ê¸¸ë™<br>ë¶€ë¬¸: ì„¸ë¡œì“°ê¸°<br><br>ìœ„ ì‚¬ëŒì€ ì„¸ë¡œì“°ê¸° ê¸°ëŠ¥ì„<br>í›Œë¥­í•˜ê²Œ í™œìš©í•˜ì˜€ê¸°ì—<br>ì´ ìƒì¥ì„ ìˆ˜ì—¬í•©ë‹ˆë‹¤.<br><br>2024ë…„ 5ì›” 20ì¼<br>ê°œë°œì ë“œë¦¼
                </span>
            </div>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('textInput');
        const paper = document.getElementById('paper');
        const contentArea = document.getElementById('contentArea');
        const bgColor = document.getElementById('bgColor');
        const fontSize = document.getElementById('fontSize');
        const lineHeight = document.getElementById('lineHeight');
        const paperHeight = document.getElementById('paperHeight');
        const autoHeightCheck = document.getElementById('autoHeightCheck');
        const fontSelect = document.getElementById('fontSelect');
        const customFontFile = document.getElementById('customFontFile');
        const textColor = document.getElementById('textColor');
        const certificateMode = document.getElementById('certificateMode');
        const logoImageFile = document.getElementById('logoImageFile');
        const topLogo = document.getElementById('topLogo');
        const saveBtn = document.getElementById('saveBtn');
        
        const stampType = document.getElementById('stampType');
        const textStampInput = document.getElementById('textStampInput');
        const imageStampInput = document.getElementById('imageStampInput');
        const stampText = document.getElementById('stampText');
        const stampColor = document.getElementById('stampColor');
        const stampImageFile = document.getElementById('stampImageFile');
        const undoStampBtn = document.getElementById('undoStampBtn');
        const clearStampsBtn = document.getElementById('clearStampsBtn');

        let stampHistory = [];

        function updateText() {
            let val = textInput.value;
            // íŠ¹ìˆ˜ë¬¸ì ì „ê° ë³€í™˜ ë° ìœ„ì¹˜ ë³´ì •
            val = val.replace(/\./g, 'ï¼')
                     .replace(/,/g, 'ï¼Œ')
                     .replace(/!/g, 'ï¼')
                     .replace(/\?/g, 'ï¼Ÿ');

            val = val.replace(/([ï¼ï¼Œï¼ï¼Ÿ])/g, '<span class="punct">$1</span>');

            contentArea.innerHTML = val.replace(/\n/g, '<br>');
        }

        textInput.addEventListener('input', updateText);

        bgColor.addEventListener('input', (e) => paper.style.backgroundColor = e.target.value);
        fontSize.addEventListener('input', (e) => paper.style.fontSize = e.target.value + 'px');
        lineHeight.addEventListener('input', (e) => paper.style.lineHeight = e.target.value / 10);
        textColor.addEventListener('input', (e) => paper.style.color = e.target.value);
        
        // ì¢…ì´ ë†’ì´ ì¡°ì ˆ ë¡œì§
        paperHeight.addEventListener('input', (e) => {
            if (!autoHeightCheck.checked) {
                paper.style.height = e.target.value + 'px';
            }
        });

        autoHeightCheck.addEventListener('change', (e) => {
            if (e.target.checked) {
                paper.style.height = 'auto'; 
                paper.style.minHeight = '700px';
                paperHeight.disabled = true;
            } else {
                paper.style.height = paperHeight.value + 'px';
                paper.style.minHeight = '';
                paperHeight.disabled = false;
            }
        });

        fontSelect.addEventListener('change', (e) => paper.style.fontFamily = e.target.value);

        // ìƒì¥ í…Œë‘ë¦¬ ëª¨ë“œ
        certificateMode.addEventListener('change', (e) => {
            if (e.target.checked) {
                paper.classList.add('certificate-mode');
            } else {
                paper.classList.remove('certificate-mode');
            }
        });

        // ìƒë‹¨ ì¤‘ì•™ ë¡œê³  ì—…ë¡œë“œ
        logoImageFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                topLogo.style.display = 'none';
                paper.classList.remove('has-logo'); // ë¡œê³  ì—†ìŒ -> ì—¬ë°± ì›ìƒë³µêµ¬
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                topLogo.src = e.target.result;
                topLogo.style.display = 'block';
                paper.classList.add('has-logo'); // ë¡œê³  ìˆìŒ -> ì—¬ë°± ëŠ˜ë¦¬ê¸°
            };
            reader.readAsDataURL(file);
        });

        // ì»¤ìŠ¤í…€ í°íŠ¸ ë¡œë”© ê°œì„ 
        customFontFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const fontData = e.target.result;
                const fontName = 'CustomFont_' + Date.now();
                const style = document.createElement('style');
                style.textContent = `
                    @font-face {
                        font-family: '${fontName}';
                        src: url('${fontData}');
                    }
                `;
                document.head.appendChild(style);
                const option = document.createElement('option');
                option.value = fontName;
                option.text = "ğŸ“‚ " + file.name;
                fontSelect.add(option, 0);
                fontSelect.value = fontName;
                paper.style.fontFamily = fontName;
                alert('í°íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            };
            reader.readAsDataURL(file);
        });

        stampType.addEventListener('change', function() {
            if (this.value === 'image') {
                textStampInput.style.display = 'none';
                imageStampInput.style.display = 'flex';
            } else {
                textStampInput.style.display = 'flex';
                imageStampInput.style.display = 'none';
            }
        });

        function addStamp() {
            const type = stampType.value;
            const div = document.createElement('div');
            div.className = `stamp ${type}`;
            div.setAttribute('tabindex', '0'); // í¬ì»¤ìŠ¤ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            
            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerText = 'X';
            delBtn.onclick = function(e) { e.stopPropagation(); div.remove(); };
            div.appendChild(delBtn);

            div.ondblclick = function(e) { e.stopPropagation(); div.remove(); };
            
            // í´ë¦­ ì‹œ ì„ íƒ íš¨ê³¼ (í…Œë‘ë¦¬ ë“±)
            div.addEventListener('click', function(e) {
                e.stopPropagation();
                document.querySelectorAll('.stamp').forEach(s => s.style.outline = 'none');
                div.style.outline = '2px dashed blue';
                // ì„ íƒëœ ë„ì¥ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬ ì •ë ¬ ê¸°ëŠ¥ì— ì‚¬ìš©
                window.selectedStamp = div;
            });

            div.style.top = (200 + Math.random() * 50) + 'px';
            div.style.right = (50 + Math.random() * 50) + 'px'; 
            div.style.left = 'auto'; // ì´ˆê¸°í™”
            
            if (type === 'image') {
                const file = stampImageFile.files[0];
                if (!file) { alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const img = document.createElement('img');
                const reader = new FileReader();
                reader.onload = function(e) { img.src = e.target.result; };
                reader.readAsDataURL(file);
                div.style.width = '80px';
                div.style.height = '80px';
                div.style.border = 'none'; 
                div.appendChild(img);
            } else {
                const txt = stampText.value;
                if (!txt) { alert('ë„ì¥ì— ë“¤ì–´ê°ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                div.style.color = stampColor.value;
                div.style.borderColor = stampColor.value;
                div.style.width = '60px';
                div.style.height = '60px';
                const span = document.createElement('span');
                span.innerText = txt;
                div.appendChild(span);
                div.style.fontSize = (50 / (txt.length > 2 ? 2 : 1.5)) + 'px';
            }
            paper.appendChild(div);
            makeDraggable(div);
            stampHistory.push(div);
            
            // ìƒì„± ì§í›„ ì„ íƒ ìƒíƒœë¡œ
            window.selectedStamp = div;
            div.style.outline = '2px dashed blue';
        }

        // ë°”íƒ• í´ë¦­ ì‹œ ë„ì¥ ì„ íƒ í•´ì œ
        paper.addEventListener('click', function() {
            document.querySelectorAll('.stamp').forEach(s => s.style.outline = 'none');
            window.selectedStamp = null;
        });

        // ë„ì¥ ì •ë ¬ í•¨ìˆ˜
        function alignStamp(position) {
            const stamp = window.selectedStamp;
            if (!stamp) {
                // ì„ íƒëœ ê²Œ ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
                if (stampHistory.length > 0) {
                    const last = stampHistory[stampHistory.length-1];
                    if (document.body.contains(last)) {
                        alignStampTarget(last, position);
                        return;
                    }
                }
                alert('ë¨¼ì € ì •ë ¬í•  ë„ì¥ì„ í´ë¦­í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            alignStampTarget(stamp, position);
        }

        function alignStampTarget(stamp, position) {
            // CSS reset
            stamp.style.right = 'auto'; 
            stamp.style.bottom = 'auto';
            
            if (position === 'center') {
                stamp.style.top = '50%';
                stamp.style.left = '50%';
                stamp.style.transform = 'translate(-50%, -50%)';
            } else if (position === 'bottom') {
                // í•˜ë‹¨ ì¤‘ì•™
                stamp.style.top = 'auto';
                stamp.style.bottom = '100px'; // í•˜ë‹¨ ì—¬ë°±
                stamp.style.left = '50%';
                stamp.style.transform = 'translateX(-50%)';
            }
        }
        
        undoStampBtn.addEventListener('click', function() {
            if (stampHistory.length > 0) {
                const lastStamp = stampHistory.pop();
                if (lastStamp && lastStamp.parentNode) lastStamp.remove();
            } else {
                const stamps = document.querySelectorAll('.stamp');
                if(stamps.length > 0) stamps[stamps.length-1].remove();
            }
        });

        clearStampsBtn.addEventListener('click', function() {
            const stamps = document.querySelectorAll('.stamp');
            if(stamps.length === 0) return;
            if(confirm('ëª¨ë“  ë„ì¥ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                stamps.forEach(s => s.remove());
                stampHistory = [];
            }
        });

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                if (e.target.className === 'delete-btn') return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                pos3 = clientX;
                pos4 = clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;
                let newTop = (elmnt.offsetTop - pos2);
                let newLeft = (elmnt.offsetLeft - pos1);
                
                elmnt.style.transform = 'none';
                
                elmnt.style.top = newTop + "px";
                elmnt.style.left = newLeft + "px";
                elmnt.style.right = 'auto';
                elmnt.style.bottom = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            }
        }

        // ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ (html-to-image ì‚¬ìš©)
        saveBtn.addEventListener('click', function() {
            const delBtns = document.querySelectorAll('.delete-btn');
            document.querySelectorAll('.stamp').forEach(s => s.style.outline = 'none');
            delBtns.forEach(b => b.style.display = 'none');

            htmlToImage.toPng(paper)
                .then(function (dataUrl) {
                    var link = document.createElement('a');
                    link.download = 'ë‚˜ë§Œì˜_ì„œì°°_ìƒì¥.png';
                    link.href = dataUrl;
                    link.click();
                    delBtns.forEach(b => b.style.display = '');
                })
                .catch(function (error) {
                    console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    delBtns.forEach(b => b.style.display = '');
                });
        });
        
        updateText();
    </script>
</body>
</html>