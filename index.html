<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ë¡œì“°ê¸° ë¬¸ì„œ ìƒì„±ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <style>
        /* ê¸°ë³¸ ì›¹í°íŠ¸ ì •ì˜ */
        @font-face { 
            font-family: 'Sangjang'; 
            src: url('ìƒì¥ì²´B-Bold.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face { font-family: 'Dobong'; src: url('dobonghan-Medium.woff') format('woff'); }
        @font-face { font-family: 'Jinin'; src: url('Jinin-B.woff') format('woff'); }
        @font-face { font-family: 'Gaehangro'; src: url('Gaehangro-H.woff') format('woff'); }
        @font-face { font-family: 'Song'; src: url('Song-B.woff') format('woff'); }
        @font-face { font-family: 'Solmoe'; src: url('SolmoeKimDaeGeonhan-Medium.woff') format('woff'); }

        /* UI ìŠ¤íƒ€ì¼ - ë ˆíŠ¸ë¡œ DOS/Windows 95 ìŠ¤íƒ€ì¼ */
        body {
            background-color: #008080;
            color: #fff;
            font-family: 'Gulim', 'Malgun Gothic', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 { 
            margin-bottom: 20px; 
            text-shadow: 2px 2px #000; 
            font-family: 'Gulim', monospace;
            background-color: #c0c0c0;
            color: #000;
            padding: 5px 20px;
            border: 2px solid #fff;
            border-right-color: #404040;
            border-bottom-color: #404040;
            box-shadow: 2px 2px 0px #000;
        }

        .container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls {
            background: #c0c0c0;
            padding: 15px;
            border: 2px solid #fff;
            border-right-color: #404040;
            border-bottom-color: #404040;
            color: #000;
            width: 340px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            max-height: 85vh;
            overflow-y: auto;
        }

        .controls::-webkit-scrollbar { width: 10px; background: #c0c0c0; }
        .controls::-webkit-scrollbar-thumb { background: #808080; border: 1px solid #c0c0c0; }

        .section-title {
            font-size: 1em;
            font-weight: bold;
            background-color: #000080;
            color: #fff;
            padding: 4px 8px;
            margin-bottom: 5px;
            margin-top: 10px;
            border: 1px inset #fff;
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        label { font-size: 0.9em; color: #000; font-weight: bold; }
        
        textarea {
            width: 100%; 
            height: 150px; 
            padding: 8px;
            background: #fff; 
            color: #000; 
            border: 2px solid #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            border-radius: 0;
            resize: vertical; 
            font-size: 16px;
            line-height: 1.6;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            font-family: 'Gulim', sans-serif;
        }

        input[type="text"], select, input[type="file"], input[type="range"], input[type="color"] {
            width: 100%; padding: 6px;
            background: #fff; color: #000; 
            border: 2px solid #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            border-radius: 0; 
            box-sizing: border-box;
            font-family: 'Gulim', sans-serif;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #e0e0e0;
            padding: 8px;
            border: 2px inset #fff;
        }
        .checkbox-group input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; }
        .checkbox-group label { margin: 0; cursor: pointer; color: #000; font-weight: bold; }

        button {
            background: #c0c0c0; 
            color: #000; 
            border: 2px solid #fff;
            border-right-color: #404040;
            border-bottom-color: #404040;
            padding: 8px 12px; 
            border-radius: 0; 
            cursor: pointer;
            font-weight: bold; 
            font-family: 'Gulim', sans-serif;
            margin-top: 5px;
        }
        button:active { 
            border: 2px solid #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            transform: translate(1px, 1px);
        }
        button:hover { background: #d0d0d0; }
        
        button.primary { color: #000080; }
        button.danger { color: #800000; }
        button.warning { color: #804000; }
        button.success { color: #004000; }

        /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .preview-wrapper {
            background: #808080;
            padding: 30px;
            border: 2px inset #fff;
            overflow-x: auto; 
            max-width: calc(100vw - 400px);
            min-width: 500px;
            display: flex;
            direction: rtl; 
            box-shadow: inset 2px 2px 5px #000;
        }

        /* ì¢…ì´ ìŠ¤íƒ€ì¼ */
        #paper {
            position: relative; 
            writing-mode: vertical-rl;
            text-orientation: mixed;
            direction: ltr; 
            text-align: left;
            
            height: 700px; 
            width: fit-content; 
            min-width: 400px;
            
            background-color: #f4e4bc;
            color: #000;
            
            /* ì˜¤ë¥¸ìª½ ì—¬ë°± 20px ì ìš© */
            padding: 50px 20px 60px 60px;
            box-sizing: border-box;
            
            font-family: 'Solmoe', 'Gungsuh', 'Batang', serif;
            font-size: 28px;
            line-height: 1.8;
            
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: break-word;
            
            transition: padding 0.3s ease, border 0.3s;
        }
        
        #paper.has-logo { padding-top: 140px; }
        
        #paper.certificate-mode {
            border: 10px double #daa520; 
            outline: 2px solid #daa520;
            outline-offset: -20px; 
        }

        #paper p { margin: 0; white-space: pre-wrap; }

        .punct {
            display: inline-block;
            position: relative;
            top: -0.35em; 
            margin-bottom: -0.35em; 
        }

        #topLogo {
            position: absolute;
            top: 25px; 
            left: 50%;
            transform: translateX(-50%);
            max-width: 100px;
            max-height: 100px;
            opacity: 0.9;
            pointer-events: none; 
            z-index: 5;
        }

        /* ë„ì¥ ìŠ¤íƒ€ì¼ */
        .stamp {
            position: absolute;
            z-index: 10;
            cursor: move;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Hanja', 'Gungsuh', serif; 
            box-sizing: border-box;
            line-height: 1.2;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            mix-blend-mode: multiply; 
            direction: ltr;
        }

        .stamp.image { box-shadow: none; }

        .stamp.square {
            border-style: solid;
            border-width: 4px;
            writing-mode: vertical-rl; 
        }

        .stamp.circle {
            border-style: solid;
            border-width: 4px;
            border-radius: 50%;
            writing-mode: vertical-rl;
        }

        .stamp img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none; 
        }

        .stamp:active { opacity: 0.8; cursor: grabbing; }

        .stamp .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #800000;
            color: white;
            border-radius: 0;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            border: 1px solid white;
            z-index: 100;
            box-shadow: 1px 1px 2px #000;
        }
        .stamp:hover .delete-btn { display: block; }

        @media (max-width: 800px) {
            .preview-wrapper { max-width: 100%; }
        }
    </style>
</head>
<body>

    <h1>ì„¸ë¡œì“°ê¸° ë¬¸ì„œ í¸ì§‘ê¸°</h1>

    <div class="container">
        <!-- ì„¤ì • íŒ¨ë„ -->
        <div class="controls">
            
            <div class="section-title">1. ê¸€ì“°ê¸° & í°íŠ¸</div>
            <div class="control-group">
                <textarea id="textInput" placeholder="ì´ê³³ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜¤ë¥¸ìª½ ì¢…ì´ì— ì„¸ë¡œë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.">
ì–´ëŠ ìŒìš¸í•˜ê³  ì“¸ì“¸í•œ ë°¤, ë‚´ê°€ ì”ëœ© ì§€ì¹œ ì±„ë¡œ ìƒê°ì— ì ê²¨,
ì‚¬ëŒë“¤ì´ ìŠì€ ì „ì„¤ë“¤ì´ ë‹´ê¸´ ì§„ê¸°í•˜ê³  í¥ë¯¸ë¡œìš´ ì±…ì„ ì½ê³  ìˆë˜ ì¤‘ì—,
ê·¸ë§Œ ì¡¸ë‹¤ê°€ ê³ ê°œë¥¼ ë„ë•ì¼ ë•Œì¯¤, ê°‘ìê¸° ë‘ë“œë¦¬ëŠ” ì†Œë¦¬ê°€ ë“¤ë ¤ì™”ë‹¤.
ëˆ„êµ°ê°€ ë¶€ë“œëŸ½ê²Œ ë‘ë“œë¦¬ëŠ”, ë‚´ ë°©ë¬¸ì„ ë‘ë“œë¦¬ëŠ” ì†Œë¦¬ê°€.
"ì•„ë§ˆ ë°©ë¬¸ê°ì¸ê°€ ë³´êµ°," ë‚˜ëŠ” ì¤‘ì–¼ê±°ë ¸ë‹¤. "ì§€ê¸ˆ ë‚´ ë°©ë¬¸ì„ ë‘ë“œë¦¬ëŠ” ì´ëŠ”â€”
ë‹¨ì§€ ê·¸ê²ƒë¿ì´ì•¼.</textarea>
            </div>

            <div class="control-group">
                <label>ê¸€ì”¨ì²´ ì„ íƒ:</label>
                <select id="fontSelect">
                    <option value="'Sangjang', serif">ìƒì¥ì²´ (ìƒì¥ ì¶”ì²œ)</option>
                    <option value="'Solmoe', 'Gungsuh', serif">ì†”ë«¼ ê¹€ëŒ€ê±´</option>
                    <option value="'Jinin', 'Gungsuh', serif">ì§€ë‹Œì²´ (ë¶“ê¸€ì”¨)</option>
                    <option value="'Dobong', sans-serif">ë„ë´‰ì˜›ê¸¸</option>
                    <option value="'Gaehangro', sans-serif">ê°œí•­ë¡œ</option>
                    <option value="'Song', serif">ì†¡ê¸€ì”¨</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>ğŸ“‚ í°íŠ¸ ì¶”ê°€ (.ttf, .woff):</label>
                <input type="file" id="customFontFile" accept=".ttf, .otf, .woff, .woff2">
            </div>

            <div class="control-group">
                <label>í¬ê¸° / ì¤„ ê°„ê²©:</label>
                <div style="display:flex; gap:5px;">
                    <input type="range" id="fontSize" min="16" max="60" value="28" style="flex:1">
                    <input type="range" id="lineHeight" min="10" max="30" value="18" style="flex:1">
                </div>
            </div>
            
            <div class="control-group">
                <label>ê¸€ì ìƒ‰ìƒ:</label>
                <input type="color" id="textColor" value="#000000">
            </div>

            <div class="section-title">2. ìƒì¥ ë° ë°°ê²½ ì„¤ì •</div>
            <div class="control-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="certificateMode">
                    <label for="certificateMode">ğŸ† ìƒì¥ í…Œë‘ë¦¬ ì ìš©</label>
                </div>
            </div>
            
            <div class="control-group">
                <label>ğŸ–¼ï¸ ë¡œê³ /ë§ˆí¬ ì‚½ì…:</label>
                <input type="file" id="logoImageFile" accept="image/*">
            </div>

            <div class="control-group">
                <label>ì¢…ì´ ìƒ‰ìƒ:</label>
                <input type="color" id="bgColor" value="#f4e4bc">
            </div>
            
            <div class="control-group">
                <label>ë¬¸ì„œ ê¸¸ì´:</label>
                <input type="range" id="paperHeight" min="400" max="1500" value="700">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="autoHeightCheck">
                <label for="autoHeightCheck">ê¸¸ì´ ìë™ í™•ì¥</label>
            </div>

            <div class="section-title">3. ë„ì¥(ë‚™ê´€)</div>
            <div class="control-group">
                <label>ë„ì¥ ì¢…ë¥˜:</label>
                <select id="stampType">
                    <option value="square">ë„¤ëª¨ ë„ì¥ (ì´ë¦„)</option>
                    <option value="circle">ì›í˜• ë„ì¥ (ì´ë¦„)</option>
                    <option value="image">ì‚¬ì§„/ì´ë¯¸ì§€ ì—…ë¡œë“œ</option>
                </select>
            </div>
            
            <div id="textStampInput" class="control-group">
                <label>ì´ë¦„ (2~4ê¸€ì):</label>
                <input type="text" id="stampText" value="í™ê¸¸ë™ì¸" maxlength="6">
                <label>ë„ì¥ ìƒ‰ìƒ:</label>
                <input type="color" id="stampColor" value="#cc0000">
            </div>

            <div id="imageStampInput" class="control-group" style="display:none;">
                <label>ë„ì¥ ì´ë¯¸ì§€:</label>
                <input type="file" id="stampImageFile" accept="image/*">
            </div>

            <button onclick="addStamp()" style="background:#c0c0c0;">[ ë„ì¥ ì°ê¸° ]</button>
            
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button onclick="alignStamp('center')" class="success" style="flex:1;">ì¤‘ì•™</button>
                <button onclick="alignStamp('bottom-left')" class="success" style="flex:1;">ì¢Œì¸¡í•˜ë‹¨</button>
                <button onclick="alignStamp('bottom-right')" class="success" style="flex:1;">ìš°ì¸¡í•˜ë‹¨</button>
            </div>

            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button id="undoStampBtn" class="warning" style="flex:1;">ì‹¤í–‰ ì·¨ì†Œ</button>
                <button id="clearStampsBtn" class="danger" style="flex:1;">ì „ì²´ ì‚­ì œ</button>
            </div>


            <div class="section-title">4. ì €ì¥</div>
            <button id="saveBtn" class="primary">ğŸ’¾ ì´ë¯¸ì§€(PNG) ì €ì¥</button>
        </div>

        <!-- ê²°ê³¼ë¬¼ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="preview-wrapper" id="previewWrapper">
            <div id="paper">
                <!-- ë¡œê³  ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ê³µê°„ -->
                <img id="topLogo" style="display:none;">
                
                <span id="contentArea">
                    ìƒ ì¥.<br><br>ì„±ëª…: í™ê¸¸ë™<br>ë¶€ë¬¸: ì„¸ë¡œì“°ê¸°<br><br>ìœ„ ì‚¬ëŒì€ ì„¸ë¡œì“°ê¸° ê¸°ëŠ¥ì„<br>í›Œë¥­í•˜ê²Œ í™œìš©í•˜ì˜€ê¸°ì—<br>ì´ ìƒì¥ì„ ìˆ˜ì—¬í•©ë‹ˆë‹¤.<br><br>2024ë…„ 5ì›” 20ì¼<br>ê°œë°œì ë“œë¦¼
                </span>
            </div>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('textInput');
        const paper = document.getElementById('paper');
        const contentArea = document.getElementById('contentArea');
        const bgColor = document.getElementById('bgColor');
        const fontSize = document.getElementById('fontSize');
        const lineHeight = document.getElementById('lineHeight');
        const paperHeight = document.getElementById('paperHeight');
        const autoHeightCheck = document.getElementById('autoHeightCheck');
        const fontSelect = document.getElementById('fontSelect');
        const customFontFile = document.getElementById('customFontFile');
        const textColor = document.getElementById('textColor');
        const certificateMode = document.getElementById('certificateMode');
        const logoImageFile = document.getElementById('logoImageFile');
        const topLogo = document.getElementById('topLogo');
        const saveBtn = document.getElementById('saveBtn');
        
        const stampType = document.getElementById('stampType');
        const textStampInput = document.getElementById('textStampInput');
        const imageStampInput = document.getElementById('imageStampInput');
        const stampText = document.getElementById('stampText');
        const stampColor = document.getElementById('stampColor');
        const stampImageFile = document.getElementById('stampImageFile');
        const undoStampBtn = document.getElementById('undoStampBtn');
        const clearStampsBtn = document.getElementById('clearStampsBtn');

        let stampHistory = [];

        function updateText() {
            let val = textInput.value;
            // íŠ¹ìˆ˜ë¬¸ì ì „ê° ë³€í™˜ ë° ìœ„ì¹˜ ë³´ì •
            val = val.replace(/\./g, 'ï¼')
                     .replace(/,/g, 'ï¼Œ')
                     .replace(/!/g, 'ï¼')
                     .replace(/\?/g, 'ï¼Ÿ');

            val = val.replace(/([ï¼ï¼Œï¼ï¼Ÿ])/g, '<span class="punct">$1</span>');

            contentArea.innerHTML = val.replace(/\n/g, '<br>');
        }

        textInput.addEventListener('input', updateText);

        bgColor.addEventListener('input', (e) => paper.style.backgroundColor = e.target.value);
        fontSize.addEventListener('input', (e) => paper.style.fontSize = e.target.value + 'px');
        lineHeight.addEventListener('input', (e) => paper.style.lineHeight = e.target.value / 10);
        textColor.addEventListener('input', (e) => paper.style.color = e.target.value);
        
        paperHeight.addEventListener('input', (e) => {
            if (!autoHeightCheck.checked) {
                paper.style.height = e.target.value + 'px';
            }
        });

        autoHeightCheck.addEventListener('change', (e) => {
            if (e.target.checked) {
                paper.style.height = 'auto'; 
                paper.style.minHeight = '700px';
                paperHeight.disabled = true;
            } else {
                paper.style.height = paperHeight.value + 'px';
                paper.style.minHeight = '';
                paperHeight.disabled = false;
            }
        });

        fontSelect.addEventListener('change', (e) => paper.style.fontFamily = e.target.value);

        certificateMode.addEventListener('change', (e) => {
            if (e.target.checked) {
                paper.classList.add('certificate-mode');
            } else {
                paper.classList.remove('certificate-mode');
            }
        });

        logoImageFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                topLogo.style.display = 'none';
                paper.classList.remove('has-logo'); 
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                topLogo.src = e.target.result;
                topLogo.style.display = 'block';
                paper.classList.add('has-logo'); 
            };
            reader.readAsDataURL(file);
        });

        customFontFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const fontData = e.target.result;
                const fontName = 'CustomFont_' + Date.now();
                const style = document.createElement('style');
                style.textContent = `
                    @font-face {
                        font-family: '${fontName}';
                        src: url('${fontData}');
                    }
                `;
                document.head.appendChild(style);
                const option = document.createElement('option');
                option.value = fontName;
                option.text = "ğŸ“‚ " + file.name;
                fontSelect.add(option, 0);
                fontSelect.value = fontName;
                paper.style.fontFamily = fontName;
                alert('í°íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            };
            reader.readAsDataURL(file);
        });

        stampType.addEventListener('change', function() {
            if (this.value === 'image') {
                textStampInput.style.display = 'none';
                imageStampInput.style.display = 'flex';
            } else {
                textStampInput.style.display = 'flex';
                imageStampInput.style.display = 'none';
            }
        });

        function addStamp() {
            const type = stampType.value;
            const div = document.createElement('div');
            if (type === 'image') {
                div.className = `stamp ${type}`; 
            } else {
                div.className = `stamp ${type}`;
            }
            div.setAttribute('tabindex', '0'); 
            
            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerText = 'X';
            delBtn.onclick = function(e) { e.stopPropagation(); div.remove(); };
            div.appendChild(delBtn);

            div.ondblclick = function(e) { e.stopPropagation(); div.remove(); };
            
            div.addEventListener('click', function(e) {
                e.stopPropagation();
                document.querySelectorAll('.stamp').forEach(s => s.style.outline = 'none');
                div.style.outline = '2px dashed blue';
                window.selectedStamp = div;
            });

            div.style.top = (200 + Math.random() * 50) + 'px';
            div.style.right = (50 + Math.random() * 50) + 'px'; 
            div.style.left = 'auto'; 
            
            if (type === 'image') {
                const file = stampImageFile.files[0];
                if (!file) { alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const img = document.createElement('img');
                const reader = new FileReader();
                reader.onload = function(e) { img.src = e.target.result; };
                reader.readAsDataURL(file);
                div.style.width = '80px';
                div.style.height = '80px';
                div.style.border = 'none'; 
                div.appendChild(img);
            } else {
                const txt = stampText.value;
                if (!txt) { alert('ë„ì¥ì— ë“¤ì–´ê°ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                div.style.color = stampColor.value;
                div.style.borderColor = stampColor.value;
                div.style.width = '60px';
                div.style.height = '60px';
                const span = document.createElement('span');
                span.innerText = txt;
                div.appendChild(span);
                div.style.fontSize = (50 / (txt.length > 2 ? 2 : 1.5)) + 'px';
            }
            paper.appendChild(div);
            makeDraggable(div);
            stampHistory.push(div);
            
            window.selectedStamp = div;
            div.style.outline = '2px dashed blue';
        }

        paper.addEventListener('click', function() {
            document.querySelectorAll('.stamp').forEach(s => s.style.outline = 'none');
            window.selectedStamp = null;
        });

        function alignStamp(position) {
            const stamp = window.selectedStamp;
            if (!stamp) {
                if (stampHistory.length > 0) {
                    const last = stampHistory[stampHistory.length-1];
                    if (document.body.contains(last)) {
                        alignStampTarget(last, position);
                        return;
                    }
                }
                alert('ë¨¼ì € ì •ë ¬í•  ë„ì¥ì„ í´ë¦­í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            alignStampTarget(stamp, position);
        }

        function alignStampTarget(stamp, position) {
            stamp.style.right = 'auto'; 
            stamp.style.bottom = 'auto';
            stamp.style.left = 'auto';
            stamp.style.top = 'auto';
            
            if (position === 'center') {
                stamp.style.top = '50%';
                stamp.style.left = '50%';
                stamp.style.transform = 'translate(-50%, -50%)';
            } else if (position === 'bottom-left') {
                // ì™¼ìª½ í•˜ë‹¨ (ì„œëª…ë€, ì„¸ë¡œì“°ê¸°ì˜ ë)
                stamp.style.bottom = '100px'; 
                stamp.style.left = '100px'; 
                stamp.style.transform = 'none';
            } else if (position === 'bottom-right') {
                // ì˜¤ë¥¸ìª½ í•˜ë‹¨ (ì‚¬ìš©ì ìš”ì²­)
                stamp.style.bottom = '100px';
                stamp.style.right = '100px';
                stamp.style.transform = 'none';
            }
        }
        
        undoStampBtn.addEventListener('click', function() {
            if (stampHistory.length > 0) {
                const lastStamp = stampHistory.pop();
                if (lastStamp && lastStamp.parentNode) lastStamp.remove();
            } else {
                const stamps = document.querySelectorAll('.stamp');
                if(stamps.length > 0) stamps[stamps.length-1].remove();
            }
        });

        clearStampsBtn.addEventListener('click', function() {
            const stamps = document.querySelectorAll('.stamp');
            if(stamps.length === 0) return;
            if(confirm('ëª¨ë“  ë„ì¥ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                stamps.forEach(s => s.remove());
                stampHistory = [];
            }
        });

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                if (e.target.className === 'delete-btn') return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                pos3 = clientX;
                pos4 = clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;
                let newTop = (elmnt.offsetTop - pos2);
                let newLeft = (elmnt.offsetLeft - pos1);
                
                elmnt.style.transform = 'none';
                
                elmnt.style.top = newTop + "px";
                elmnt.style.left = newLeft + "px";
                elmnt.style.right = 'auto';
                elmnt.style.bottom = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            }
        }

        // ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ (html-to-image ì‚¬ìš©)
        saveBtn.addEventListener('click', function() {
            // ë„ì¥ ì„ íƒ íš¨ê³¼(í…Œë‘ë¦¬) ì œê±°
            document.querySelectorAll('.stamp').forEach(s => s.style.outline = 'none');
            window.selectedStamp = null;

            // ë¡œë”© í‘œì‹œ (ì˜µì…˜)
            const originalText = saveBtn.innerText;
            saveBtn.innerText = 'ì €ì¥ ì¤‘...';

            htmlToImage.toPng(paper, {
                quality: 1.0,
                pixelRatio: 2, // ê³ í™”ì§ˆ
                backgroundColor: paper.style.backgroundColor || '#f4e4bc', // ë°°ê²½ìƒ‰ ëª…ì‹œ
                width: paper.scrollWidth, // ì„¸ë¡œì“°ê¸° ì‹œ ë„ˆë¹„ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ëª…ì‹œ
                height: paper.scrollHeight,
                filter: (node) => {
                    // ìº¡ì²˜ ì‹œ ì œì™¸í•  ìš”ì†Œ: ì‚­ì œ ë²„íŠ¼
                    return !node.classList || !node.classList.contains('delete-btn');
                }
            })
            .then(function (dataUrl) {
                var link = document.createElement('a');
                link.download = 'ë‚˜ë§Œì˜_ì„œì°°_ìƒì¥.png';
                link.href = dataUrl;
                link.click();
                saveBtn.innerText = originalText;
            })
            .catch(function (error) {
                console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
                saveBtn.innerText = originalText;
            });
        });
        
        updateText();
    </script>
</body>
</html>

